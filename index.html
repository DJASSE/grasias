<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ثانوية أمــوشان رابح بقدارة</title>

  <!-- Font & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <style>
    /* ========= Base & Reset ========= */
    :root{
      --blue:#0b67b2; --green:#2aa66a; --muted:#6b7280; --card:#ffffff; --bg:#f6fbff;
      --radius:12px; --glass: rgba(255,255,255,0.6);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:'Cairo',sans-serif;background:linear-gradient(180deg,#f6fbff,#ffffff);
      color:#06304a;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;line-height:1.45;
      direction:rtl;
    }
    a{color:inherit;text-decoration:none}
    .container{max-width:1100px;margin:0 auto;padding:16px}

    /* ===== Notification Bar ===== */
    .notif-bar{
      display:flex;align-items:center;justify-content:space-between;padding:10px 16px;background:var(--blue);
      color:#fff;font-weight:700;position:sticky;top:0;z-index:1000;border-bottom:4px solid rgba(0,0,0,0.03)
    }
    .notif-msg{overflow:hidden;white-space:nowrap;display:inline-block;animation:marquee 12s linear infinite}
    @keyframes marquee{0%{transform:translateX(0)}100%{transform:translateX(-95%)}}
    .notif-hide{background:transparent;border:1px solid rgba(255,255,255,0.12);color:#fff;padding:6px 10px;border-radius:8px;cursor:pointer}

    /* ===== Header ===== */
    header{padding:16px 0}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,var(--blue),#1ea6ff);color:#fff;display:grid;place-items:center;font-weight:800;box-shadow:0 8px 24px rgba(11,103,178,0.08)}
    .school-title{display:flex;flex-direction:column}
    .school-title .name{font-size:20px;color:var(--blue);font-weight:800}
    .school-title .sub{font-size:13px;color:var(--muted)}

    nav.main-nav{display:flex;gap:8px;align-items:center}
    nav a{padding:8px 12px;border-radius:10px;color:var(--blue);font-weight:700;transition:all .12s ease}
    nav a:hover{background:rgba(11,103,178,0.06);transform:translateY(-3px)}
    nav a.active{background:var(--blue);color:#fff}

    /* ===== Layout ===== */
    .hero{display:flex;gap:18px;align-items:center;background:linear-gradient(180deg, rgba(11,103,178,0.03), rgba(42,166,106,0.02));padding:18px;border-radius:14px;margin:12px 0;box-shadow:0 14px 40px rgba(8,48,75,0.03)}
    .hero .welcome h1{margin:0;font-size:22px;color:var(--blue)}
    .hero .welcome p{margin:8px 0;color:var(--muted)}
    .credit{display:inline-block;margin-top:8px;padding:6px 10px;border-radius:8px;background:rgba(11,103,178,0.06);color:var(--blue);font-weight:700}

    /* ===== Slider ===== */
    .slider{width:360px;border-radius:12px;overflow:hidden;box-shadow:0 12px 40px rgba(8,48,75,0.06)}
    .slides{position:relative;height:170px}
    .slide{position:absolute;inset:0;background-size:cover;background-position:center;display:grid;place-items:end;padding:12px;color:#fff}
    .slide .caption{background:rgba(0,0,0,0.3);padding:8px 10px;border-radius:10px}

    /* ===== Grid area ===== */
    .grid{display:grid;grid-template-columns:1fr 360px;gap:16px;margin-top:14px}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} .slider{width:100%} .slides{height:140px} .hero{flex-direction:column;align-items:flex-start} }

    /* ===== Cards & News ===== */
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 10px 30px rgba(8,48,75,0.04)}
    .news-list{display:grid;gap:12px}
    .news-item{border-radius:10px;padding:12px;background:linear-gradient(180deg,#fff,#fbfeff);border:1px solid rgba(11,103,178,0.04);transition:transform .12s}
    .news-item:hover{transform:translateY(-6px);box-shadow:0 16px 36px rgba(8,48,75,0.06)}
    .news-item .meta{font-size:13px;color:var(--muted)}

    /* ===== Tables ===== */
    table{width:100%;border-collapse:collapse;font-size:14px}
    table th, table td{padding:10px;border-bottom:1px dashed rgba(8,48,75,0.06);text-align:right}

    /* ===== Buttons & inputs ===== */
    .btn{background:var(--blue);color:#fff;padding:8px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
    .btn.secondary{background:transparent;color:var(--blue);border:1px solid rgba(11,103,178,0.12)}
    input, textarea, select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(8,48,75,0.06);margin-top:8px}
    .small{padding:6px 8px}

    /* ===== Sidebar ===== */
    .sidebar .contact-item{display:flex;gap:12px;align-items:center;color:var(--muted);margin-top:8px}

    /* ===== Tabs ===== */
    .tabs{display:flex;gap:8px;margin-top:8px}
    .tab-btn{padding:8px 10px;border-radius:10px;background:transparent;border:1px solid rgba(8,48,75,0.05);cursor:pointer}
    .tab-btn.active{background:var(--blue);color:#fff}

    /* ===== Footer ===== */
    footer{padding:18px 0;margin-top:18px;border-top:1px solid rgba(8,48,75,0.04);background:linear-gradient(180deg,#fff,#f7fcff)}

    /* ===== Misc ===== */
    .muted{color:var(--muted)}
    .hidden{display:none}
    .row{display:flex;gap:10px;align-items:center}
    .right{justify-content:flex-start}
  </style>
</head>
<body>

  <!-- ========== Notification Bar ========== -->
  <div id="notifBar" class="notif-bar" aria-live="polite">
    <div class="notif-msg" id="notifMsg">تحميل الإشعارات...</div>
    <div>
      <button id="notifToggle" class="notif-hide small"><i class="fa-regular fa-bell"></i> إخفاء</button>
    </div>
  </div>

  <!-- ========== Header ========== -->
  <header class="container">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true">أمــوشان</div>
        <div class="school-title">
          <div class="name">ثانوية أمــوشان رابح بقدارة</div>
          <div class="sub">تعليم · تربية · تميز</div>
        </div>
      </div>

      <nav class="main-nav" role="navigation" aria-label="القائمة الرئيسية">
        <a href="#" class="nav-link active" data-view="home"><i class="fa-solid fa-house"></i> الرئيسية</a>
        <a href="#" class="nav-link" data-view="news"><i class="fa-solid fa-newspaper"></i> الأخبار</a>
        <a href="#" class="nav-link" data-view="exams"><i class="fa-solid fa-calendar-check"></i> جداول الاختبارات</a>
        <a href="#" class="nav-link" data-view="schedule"><i class="fa-solid fa-clock"></i> مواعيد الدراسة</a>
        <a href="#" class="nav-link" data-view="login"><i class="fa-solid fa-user-lock"></i> دخول الأدمن</a>
      </nav>
    </div>
  </header>

  <main class="container" id="app">

    <!-- ========== HOME VIEW ========== -->
    <section id="view-home" class="view">
      <div class="hero card">
        <div class="welcome">
          <h1>مرحبا بكم في ثانوية أمــوشان رابح بقدارة</h1>
          <p>نقدم بيئة تعليمية محفزة، هذا الموقع يعرض آخر الأخبار، جداول الاختبارات، ومواعيد الحصص.</p>
          <div class="credit">من فكرة أستاذة الإعلام الآلي وبرمجة تلميذها جاسر اشلاف</div>
          <div style="margin-top:12px" class="row right">
            <button class="btn" onclick="goTo('news')"><i class="fa-solid fa-newspaper"></i> آخر الأخبار</button>
            <button class="btn secondary" onclick="goTo('exams')"><i class="fa-solid fa-table-list"></i> جداول الاختبارات</button>
          </div>
        </div>

        <div class="slider">
          <div class="slides" id="homeSlides">
            <div class="slide" style="background-image:url('https://images.unsplash.com/photo-1503676260728-1c00da094a0b?q=80&w=1200')">
              <div class="caption">فعاليات مدرسية</div>
            </div>
            <div class="slide" style="background-image:url('https://images.unsplash.com/photo-1523240795612-9a054b0db644?q=80&w=1200')">
              <div class="caption">ورشات تقنية</div>
            </div>
            <div class="slide" style="background-image:url('https://images.unsplash.com/photo-1497493292307-31c376b6e479?q=80&w=1200')">
              <div class="caption">المكتبة والموارد</div>
            </div>
          </div>
        </div>
      </div>

      <div class="grid">
        <div>
          <div class="card">
            <h3><i class="fa-solid fa-newspaper"></i> آخر الأخبار</h3>
            <div id="homeNewsPreview" class="muted">تحميل الأخبار...</div>
          </div>

          <div id="homeExamsPreview" class="card" style="margin-top:12px">
            <h3><i class="fa-solid fa-calendar-check"></i> جداول الاختبارات (قريبًا)</h3>
            <div class="muted">تحميل...</div>
          </div>
        </div>

        <aside class="sidebar">
          <div class="card">
            <h4><i class="fa-solid fa-clock"></i> مواعيد الدراسة</h4>
            <div class="muted" id="homeSchedulePreview">جارٍ التحميل...</div>
          </div>

          <div class="card" style="margin-top:12px">
            <h4><i class="fa-solid fa-phone"></i> تواصل</h4>
            <div class="contact-item muted">هاتف: +213 5X XXX XXXX</div>
            <div class="contact-item muted">بريد: contact@amouchan.edu.dz</div>
          </div>
        </aside>
      </div>
    </section>

    <!-- ========== NEWS VIEW ========== -->
    <section id="view-news" class="view hidden">
      <div class="card">
        <h2><i class="fa-solid fa-newspaper"></i> الأخبار والمستجدات</h2>
        <div id="newsList" class="news-list" aria-live="polite"></div>

        <!-- Admin panel -->
        <div id="newsAdminPanel" class="admin-panel card hidden" style="margin-top:12px">
          <h3>لوحة الأدمن — إدارة الأخبار</h3>
          <input id="newsTitleInput" placeholder="عنوان الخبر" />
          <select id="newsTypeInput">
            <option value="normal">عادي</option>
            <option value="urgent">عاجل</option>
          </select>
          <textarea id="newsBodyInput" rows="4" placeholder="محتوى الخبر"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="addNewsBtn" class="btn">أضف خبر</button>
            <button id="logoutBtn_news" class="btn secondary">تسجيل خروج</button>
          </div>
          <small class="muted">الكتابة تحفظ مباشرة في قاعدة Firebase Realtime Database.</small>
        </div>
      </div>
    </section>

    <!-- ========== EXAMS VIEW ========== -->
    <section id="view-exams" class="view hidden">
      <div class="card">
        <h2><i class="fa-solid fa-calendar-check"></i> جداول الاختبارات</h2>

        <div id="examsList" style="margin-bottom:12px">جارٍ التحميل...</div>

        <!-- Admin panel -->
        <div id="examsAdminPanel" class="admin-panel card hidden">
          <h3>إدارة جداول الاختبارات</h3>
          <input id="examSubject" placeholder="المادة" />
          <input id="examDate" type="date" />
          <input id="examTime" placeholder="مثال: 09:00 - 11:00" />
          <input id="examRoom" placeholder="القاعة" />
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="addExamBtn" class="btn">أضف اختبار</button>
            <button id="logoutBtn_exams" class="btn secondary">تسجيل خروج</button>
          </div>
        </div>
      </div>
    </section>

    <!-- ========== SCHEDULE VIEW ========= -->
    <section id="view-schedule" class="view hidden">
      <div class="card">
        <h2><i class="fa-solid fa-clock"></i> مواعيد الدراسة</h2>
        <p class="muted">اختر السنة لعرض أو تعديل مواعيد الحصص</p>

        <div class="tabs" style="margin-top:8px">
          <button class="tab-btn active" data-grade="1">الأولى ثانوي</button>
          <button class="tab-btn" data-grade="2">الثانية ثانوي</button>
          <button class="tab-btn" data-grade="3">الثالثة ثانوي</button>
        </div>

        <div id="gradeContent" style="margin-top:12px">
          جارٍ التحميل...
        </div>

        <div id="scheduleAdminPanel" class="admin-panel card hidden" style="margin-top:12px">
          <h3>تعديل مواعيد الحصص (Admin)</h3>
          <label>الفترة:
            <select id="periodSelect">
              <option value="morning">صباحًا</option>
              <option value="evening">مساءً</option>
            </select>
          </label>
          <input id="periodName" placeholder="مثال: الحصة الأولى" />
          <input id="periodTime" placeholder="08:00 - 08:45" />
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="addPeriodBtn" class="btn">أضف / حدّث</button>
            <button id="logoutBtn_schedule" class="btn secondary">تسجيل خروج</button>
          </div>
        </div>
      </div>
    </section>

    <!-- ========== LOGIN VIEW ========= -->
    <section id="view-login" class="view hidden">
      <div class="card" style="max-width:520px;margin:12px auto">
        <h2><i class="fa-solid fa-user-lock"></i> تسجيل دخول الأدمن</h2>
        <p class="muted">استخدم بريد الأدمن وكلمة المرور (يمكنك إنشاء حساب الأدمن عبر Firebase Console).</p>
        <input id="loginEmail" type="email" placeholder="البريد الإلكتروني" />
        <input id="loginPassword" type="password" placeholder="كلمة المرور" />
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="loginBtn" class="btn">دخول</button>
          <button id="backHomeBtn" class="btn secondary">عودة للرئيسية</button>
        </div>
        <p id="loginMsg" class="muted" style="margin-top:8px"></p>
      </div>
    </section>

  </main>

  <!-- ========== Footer ========= -->
  <footer class="container">
    <div class="card" style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
      <div>
        <strong>ثانوية أمــوشان رابح بقدارة</strong>
        <div class="muted">حي بقدارة - ولاية ... - الجزائر</div>
      </div>
      <div class="muted">© جميع الحقوق محفوظة — تصميم عصري ودعم RTL</div>
    </div>
  </footer>

  <!-- ========== Firebase + App Script (module) ========= -->
  <script type="module">
  /******************************************************************
   *  Single-file app using Firebase Realtime Database + Auth
   *
   *  IMPORTANT:
   *   - Replace firebaseConfig with your project's config below.
   *   - Create an Admin user in Firebase Console (Auth → Add user) and
   *     restrict Realtime Database writes to that user's UID (see rules below).
   ******************************************************************/

  // Firebase modular imports (Realtime + Auth)
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
  import {
    getDatabase, ref, push, set, onValue, remove, update, get, child
  } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js';

  // ======= CONFIG: REPLACE with your Firebase project's credentials =======
  const firebaseConfig = {
    apiKey: "REPLACE_API_KEY",
    authDomain: "REPLACE_AUTH_DOMAIN",
    databaseURL: "REPLACE_DATABASE_URL", // important for Realtime DB
    projectId: "REPLACE_PROJECT_ID",
    storageBucket: "REPLACE_STORAGE_BUCKET",
    messagingSenderId: "REPLACE_SENDER_ID",
    appId: "REPLACE_APP_ID"
  };
  // ========================================================================

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  // ===== Helpers =====
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  function showView(viewId){
    document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
    const target = document.getElementById('view-' + viewId);
    if(target) target.classList.remove('hidden');
    // highlight nav
    $$('.nav-link').forEach(a => a.classList.toggle('active', a.dataset.view === viewId));
    // update hash (for navigation)
    history.replaceState(null, '', '#' + viewId);
  }
  function goTo(view){ showView(view); window.scrollTo({top:0,behavior:'smooth'}); }

  // Nav links
  $$('.nav-link').forEach(a => a.addEventListener('click', (e) => { e.preventDefault(); goTo(a.dataset.view); }));

  // Notification bar toggle
  $('#notifToggle').addEventListener('click', () => {
    const bar = $('#notifBar');
    bar.style.display = (bar.style.display === 'none') ? 'flex' : 'none';
    $('#notifToggle').textContent = bar.style.display === 'none' ? 'إظهار' : 'إخفاء';
  });

  // ===== State =====
  let currentUser = null; // firebase user
  let adminUID = null;    // can be used for client-side checks; real security via DB rules
  // (You can fetch adminUID from a protected path in DB if you want dynamic admin.)

  // ===== Auth state listener =====
  onAuthStateChanged(auth, user => {
    currentUser = user;
    // show/hide admin panels
    const isAdmin = !!user;
    toggleAdminPanels(isAdmin);
    // store adminUID for client checks (not secure by itself)
    adminUID = user ? user.uid : null;
  });

  function toggleAdminPanels(show){
    const panels = ['#newsAdminPanel','#examsAdminPanel','#scheduleAdminPanel'];
    panels.forEach(s => {
      const el = document.querySelector(s);
      if(el) el.classList.toggle('hidden', !show);
    });
  }

  // ====== Real-time listeners & data functions ======

  // -- NEWS --
  const newsRef = ref(db, 'news');
  function listenNews(){
    onValue(newsRef, snapshot => {
      const data = snapshot.val() || {};
      // data is an object of keys
      const items = Object.keys(data).map(k => ({ id: k, ...data[k] })).sort((a,b) => (b.createdAt||0) - (a.createdAt||0));
      renderNews(items);
      // update home preview
      const first = items[0];
      $('#homeNewsPreview').textContent = first ? first.title : 'لا توجد أخبار حتى الآن.';
      // if urgent, show in notif bar
      const urgent = items.find(x => x.type === 'urgent');
      if(urgent){
        $('#notifMsg').textContent = urgent.title + ' — ' + urgent.body;
        $('#notifBar').style.background = '#c53030';
        setTimeout(()=> $('#notifBar').style.background = 'var(--blue)'.replace('var(--blue)',''), 3500);
      } else {
        $('#notifMsg').textContent = 'لا توجد إشعارات عاجلة حالياً.';
        $('#notifBar').style.background = 'var(--blue)';
      }
    });
  }

  function renderNews(items){
    const list = $('#newsList');
    if(!list) return;
    if(items.length === 0){ list.innerHTML = '<p>لا توجد أخبار.</p>'; return; }
    list.innerHTML = '';
    items.forEach(it => {
      const d = document.createElement('div');
      d.className = 'news-item';
      d.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:start;gap:12px">
          <div>
            <div style="font-weight:800">${escapeHtml(it.title)}</div>
            <div class="meta">${new Date(it.createdAt||0).toLocaleString('ar-DZ') || ''} · ${it.type === 'urgent' ? '<span style="color:#c53030;font-weight:800">عاجل</span>' : ''}</div>
            <div style="margin-top:8px">${escapeHtml(it.body)}</div>
          </div>
          <div style="width:56px;height:56px;border-radius:10px;display:grid;place-items:center;background:linear-gradient(180deg,#fff,#eef9ff)">
            <i class="fa-solid fa-newspaper" style="color:var(--blue)"></i>
          </div>
        </div>
      `;
      // admin controls
      if(currentUser){
        const row = document.createElement('div'); row.style.marginTop = '8px';
        const pinBtn = document.createElement('button'); pinBtn.className='btn secondary small'; pinBtn.textContent='نشر كإشعار';
        pinBtn.addEventListener('click', ()=> {
          // pin by setting /pinnedNews
          set(ref(db, 'pinnedNews'), { id: it.id, title: it.title, body: it.body, type: it.type, at: Date.now() })
            .then(()=> alert('تم نشر الإشعار'))
            .catch(e=> alert('خطأ: '+ e.message));
        });
        const delBtn = document.createElement('button'); delBtn.className='btn secondary small'; delBtn.textContent='حذف';
        delBtn.style.marginLeft = '8px';
        delBtn.addEventListener('click', ()=> {
          if(!confirm('هل تريد حذف هذا الخبر؟')) return;
          remove(ref(db, 'news/' + it.id)).catch(e => alert('خطأ: ' + e.message));
        });
        row.appendChild(pinBtn); row.appendChild(delBtn);
        d.appendChild(row);
      }
      list.appendChild(d);
    });
  }

  // add news
  $('#addNewsBtn')?.addEventListener('click', async () => {
    const title = $('#newsTitleInput').value.trim();
    const body = $('#newsBodyInput').value.trim();
    const type = $('#newsTypeInput').value;
    if(!title || !body){ alert('أكمل حقول الخبر'); return; }
    const newRef = push(newsRef);
    await set(newRef, { title, body, type, createdAt: Date.now() });
    $('#newsTitleInput').value = ''; $('#newsBodyInput').value = '';
  });

  // listen to pinnedNews (notification bar)
  onValue(ref(db, 'pinnedNews'), snap => {
    const p = snap.val();
    if(p && p.title){
      $('#notifMsg').textContent = `${p.title} — ${p.body}`;
      $('#notifBar').style.background = (p.type === 'urgent') ? '#c53030' : 'var(--blue)';
    }
  });

  // -- EXAMS --
  const examsRef = ref(db, 'exams');
  function listenExams(){
    onValue(examsRef, snap => {
      const data = snap.val() || {};
      const items = Object.keys(data).map(k => ({ id: k, ...data[k] })).sort((a,b)=> a.date.localeCompare(b.date));
      renderExams(items);
      // preview on home
      const homeDiv = $('#homeExamsPreview');
      if(homeDiv) homeDiv.textContent = items.length ? `${items[0].subject} — ${items[0].date}` : 'لا توجد اختبارات مجدولة.';
    });
  }

  function renderExams(items){
    const el = $('#examsList');
    if(!el) return;
    if(items.length === 0){ el.innerHTML = '<p>لا توجد اختبارات.</p>'; return; }
    let html = '<table><thead><tr><th>المادة</th><th>اليوم</th><th>التوقيت</th><th>القاعة</th><th></th></tr></thead><tbody>';
    items.forEach(it => {
      html += `<tr>
        <td>${escapeHtml(it.subject)}</td>
        <td>${escapeHtml(it.date)}</td>
        <td>${escapeHtml(it.time)}</td>
        <td>${escapeHtml(it.room)}</td>
        <td>${currentUser ? `<button class="btn secondary small" data-id="${it.id}" data-action="delExam">حذف</button>` : ''}</td>
      </tr>`;
    });
    html += '</tbody></table>';
    el.innerHTML = html;
    // attach delete handlers
    el.querySelectorAll('[data-action="delExam"]').forEach(b => {
      b.addEventListener('click', e=>{
        const id = e.target.dataset.id;
        if(!confirm('حذف الاختبار؟')) return;
        remove(ref(db, 'exams/' + id)).catch(err => alert('خطأ: ' + err.message));
      });
    });
  }

  $('#addExamBtn')?.addEventListener('click', async ()=>{
    const subject = $('#examSubject').value.trim();
    const date = $('#examDate').value;
    const time = $('#examTime').value.trim();
    const room = $('#examRoom').value.trim();
    if(!subject || !date || !time){ alert('أكمل الحقول'); return; }
    const newRef = push(examsRef);
    await set(newRef, { subject, date, time, room, createdAt: Date.now() });
    $('#examSubject').value='';$('#examDate').value='';$('#examTime').value='';$('#examRoom').value='';
  });

  // -- SCHEDULES --
  // store at /schedules/grade_1 -> { morning: [{name,time},...], evening: [...] }
  function listenSchedules(){
    onValue(ref(db, 'schedules'), snap => {
      const data = snap.val() || {};
      // build previews for home
      const g1 = data['grade_1'] || { morning:[], evening:[] };
      $('#homeSchedulePreview').textContent = `الأولى: ${g1.morning?.length||0} حصة صباحًا · ${g1.evening?.length||0} مساءً`;
      // if current schedule page active, re-render for current grade
      const grade = currentGrade;
      if(grade) renderGrade(grade);
    });
  }

  let currentGrade = 1;
  async function loadGrade(grade){
    currentGrade = grade;
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', +b.dataset.grade === grade));
    renderGrade(grade);
  }

  async function renderGrade(grade){
    const snap = await get(ref(db, 'schedules/grade_' + grade));
    const data = snap.exists() ? snap.val() : { morning: [], evening: [] };
    const morning = data.morning || [];
    const evening = data.evening || [];
    const container = $('#gradeContent');
    let html = `<div class="card"><h4>صباحًا</h4><ul>${morning.length ? morning.map((p,idx)=> `<li>${escapeHtml(p.name)} — <span class="muted">${escapeHtml(p.time)}</span> ${currentUser?`<button class="btn secondary small" data-action="delM" data-idx="${idx}">حذف</button>`:''}</li>`).join('') : '<li>لا توجد مواعيد</li>'}</ul></div>`;
    html += `<div class="card" style="margin-top:12px"><h4>مساءً</h4><ul>${evening.length ? evening.map((p,idx)=> `<li>${escapeHtml(p.name)} — <span class="muted">${escapeHtml(p.time)}</span> ${currentUser?`<button class="btn secondary small" data-action="delE" data-idx="${idx}">حذف</button>`:''}</li>`).join('') : '<li>لا توجد مواعيد</li>'}</ul></div>`;
    container.innerHTML = html;
    // attach delete handlers
    container.querySelectorAll('[data-action="delM"]').forEach(btn => btn.addEventListener('click', async e=>{
      const idx = +e.target.dataset.idx;
      morning.splice(idx,1);
      await set(ref(db, 'schedules/grade_' + grade), { morning, evening, updatedAt: Date.now() });
      await renderGrade(grade);
    }));
    container.querySelectorAll('[data-action="delE"]').forEach(btn => btn.addEventListener('click', async e=>{
      const idx = +e.target.dataset.idx;
      evening.splice(idx,1);
      await set(ref(db, 'schedules/grade_' + grade), { morning, evening, updatedAt: Date.now() });
      await renderGrade(grade);
    }));
  }

  $('#addPeriodBtn')?.addEventListener('click', async ()=>{
    const period = $('#periodSelect').value;
    const name = $('#periodName').value.trim();
    const time = $('#periodTime').value.trim();
    if(!name || !time){ alert('أكمل بيانات الحصة'); return; }
    const snap = await get(ref(db, 'schedules/grade_' + currentGrade));
    const data = snap.exists() ? snap.val() : { morning: [], evening: [] };
    const morning = data.morning || [];
    const evening = data.evening || [];
    if(period === 'morning') morning.push({ name, time });
    else evening.push({ name, time });
    await set(ref(db, 'schedules/grade_' + currentGrade), { morning, evening, updatedAt: Date.now() });
    $('#periodName').value = ''; $('#periodTime').value = '';
    renderGrade(currentGrade);
  });

  // tab buttons for grades
  document.querySelectorAll('.tab-btn').forEach(b => b.addEventListener('click', (e) => {
    const gr = +e.target.dataset.grade; loadGrade(gr);
  }));

  // ===== LOGIN / LOGOUT =====
  $('#loginBtn')?.addEventListener('click', async ()=>{
    const email = $('#loginEmail').value.trim();
    const pw = $('#loginPassword').value;
    if(!email || !pw){ $('#loginMsg').textContent = 'أدخل البريد وكلمة السر'; return; }
    $('#loginMsg').textContent = 'جاري تسجيل الدخول...';
    try{
      await signInWithEmailAndPassword(auth, email, pw);
      $('#loginMsg').textContent = 'تم تسجيل الدخول.';
      // go to news page
      setTimeout(()=> goTo('news'), 600);
    }catch(err){
      console.error(err);
      $('#loginMsg').textContent = 'فشل الدخول: ' + err.message;
    }
  });

  // logout buttons (multiple)
  ['#logoutBtn_news','#logoutBtn_exams','#logoutBtn_schedule'].forEach(sel=>{
    const btn = document.querySelector(sel);
    if(btn) btn.addEventListener('click', async ()=> { await signOut(auth); alert('تم تسجيل الخروج'); goTo('home'); });
  });

  // backHomeBtn
  $('#backHomeBtn')?.addEventListener('click', ()=> goTo('home'));

  // ===== Initial listeners to DB =====
  listenNews();
  listenExams();
  listenSchedules();

  // when page loads, infer view from hash
  const initial = location.hash ? location.hash.replace('#','') : 'home';
  showView(initial);

  // home slider simple auto-switch
  (function homeSlider(){
    const slides = Array.from(document.querySelectorAll('#homeSlides .slide'));
    if(!slides.length) return;
    slides.forEach((s,i)=> s.style.display = i===0 ? 'block' : 'none');
    let idx = 0;
    setInterval(()=> {
      slides[idx].style.opacity = 0; slides[idx].style.display = 'none';
      idx = (idx + 1) % slides.length;
      slides[idx].style.display = 'block';
    }, 4200);
  })();

  // ===== Small utilities =====
  function escapeHtml(s){
    return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
  }

  // ===== Simple UI toggles for admin panels based on auth state (client-side) =====
  onAuthStateChanged(auth, user => {
    currentUser = user;
    const isAdmin = !!user;
    document.querySelectorAll('.admin-panel').forEach(p => p.classList.toggle('hidden', !isAdmin));
    // For security: client-side only; real protection via DB rules
  });

  // ===== Show/Hide admin panels initially (hidden) =====
  document.querySelectorAll('.admin-panel').forEach(p => p.classList.add('hidden'));

  // ===== END of module =====
  </script>

  <!-- ============================ -->
  <!-- Security rules & instructions -->
  <!-- ============================ -->
  <!--
    IMPORTANT - Realtime Database Security Rules (set these in Firebase Console -> Realtime Database -> Rules):

    {
      "rules": {
        ".read": true,
        ".write": "auth != null && auth.uid === 'ADMIN_UID_HERE'"
      }
    }

    - استبدل 'ADMIN_UID_HERE' بـ UID الخاص بحساب الأدمن الذي أنشأته في Firebase Authentication.
    - هذا يمنع أي كتابة (إضافة/تعديل/حذف) إلا من قبل ذلك المستخدم المصادق عليه.
    - إذا أردت السماح لعدة UID، استخدم شرط مثل: auth.uid in ['UID1','UID2']

    تعليمات سريعة لإنشاء أدمن:
      1) فتح Firebase Console -> Authentication -> Users -> Add user
      2) أدخل إيميل وكلمة مرور، ثم اضغط إضافة.
      3) بعد الإنشاء، انسخ الـ UID من صفحة المستخدم (انقر على السجل).
      4) ضع الـ UID في قواعد Realtime Database بدل ADMIN_UID_HERE.

    ملاحظة أخيرة:
      - استبدل firebaseConfig أعلاه بالقيم الحقيقية من إعدادات مشروعك.
      - يُنصح بتجربة قواعد في وضع test ثم تغييرها للإنتاج.
  -->

</body>
</html>
