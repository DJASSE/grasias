<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>gracias</title>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, RecaptchaVerifier, signInWithPhoneNumber, PhoneAuthProvider, signInWithCredential } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getDatabase, ref, set, get, push, onValue, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAekz29R9IwY1pygd4Mic5AX8XZ7A7Z4Fs",
            authDomain: "grasias-d7830.firebaseapp.com",
            databaseURL: "https://grasias-d7830-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "grasias-d7830",
            storageBucket: "grasias-d7830.firebasestorage.app",
            messagingSenderId: "134413476604",
            appId: "1:134413476604:web:ab1acfa69c025218cbad79",
            measurementId: "G-6QBYM41CJ1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // ØªØµØ¯ÙŠØ± Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹Ø§Ù…
        window.auth = auth;
        window.db = db;
        window.ref = ref;
        window.set = set;
        window.get = get;
        window.push = push;
        window.onValue = onValue;
        window.update = update;
        window.RecaptchaVerifier = RecaptchaVerifier;
        window.signInWithPhoneNumber = signInWithPhoneNumber;
        window.PhoneAuthProvider = PhoneAuthProvider;
        window.signInWithCredential = signInWithCredential;
    </script>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            direction: rtl;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .page {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            animation: fadeIn 0.5s ease-in;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .logo p {
            color: #718096;
            font-size: 1.1em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2d3748;
            font-weight: 600;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            direction: rtl;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .phone-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .phone-btn:hover {
            box-shadow: 0 10px 25px rgba(72, 187, 120, 0.3);
        }

        .role-selection {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .role-card {
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .role-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .role-card.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .role-card .icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .role-card h3 {
            color: #2d3748;
            margin-bottom: 5px;
        }

        .role-card p {
            color: #718096;
            font-size: 0.9em;
        }

        .message {
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }

        .message.success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .message.error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }

        .message.info {
            background: #bee3f8;
            color: #2a4365;
            border: 1px solid #90cdf4;
        }

        /* ØµÙØ­Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© */
        .map-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            background: white;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .map-sidebar {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 350px;
            max-height: calc(100vh - 40px);
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 1001;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0;
            text-align: center;
        }

        .sidebar-content {
            padding: 20px;
        }

        .user-info {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 10px;
        }

        .driver-card {
            background: #f7fafc;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #e2e8f0;
        }

        .driver-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .driver-name {
            font-weight: 600;
            color: #2d3748;
        }

        .driver-distance {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.8em;
        }

        .car-info {
            color: #718096;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .driver-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 6px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .call-btn {
            background: #48bb78;
            color: white;
        }

        .chat-btn {
            background: #4299e1;
            color: white;
        }

        .select-btn {
            background: #667eea;
            color: white;
        }

        .trip-status {
            background: #fed7d7;
            color: #742a2a;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
        }

        .trip-status.active {
            background: #c6f6d5;
            color: #22543d;
        }

        .map-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1001;
        }

        .control-btn {
            display: block;
            width: 50px;
            height: 50px;
            background: white;
            border: none;
            border-radius: 50%;
            margin-bottom: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            transform: scale(1.1);
        }

        /* Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© */
        .chat-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            height: 400px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 1002;
            display: none;
            flex-direction: column;
        }

        .chat-header {
            padding: 15px;
            background: #667eea;
            color: white;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 10px;
            max-width: 80%;
        }

        .message.sent {
            background: #667eea;
            color: white;
            margin-left: auto;
        }

        .message.received {
            background: #f7fafc;
            color: #2d3748;
        }

        .chat-input-container {
            padding: 15px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            outline: none;
        }

        .send-btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
        }

        /* Ø¥Ø´Ø¹Ø§Ø±Ø§Øª */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 1003;
            min-width: 300px;
            text-align: center;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #2d3748;
        }

        .notification-content {
            color: #718096;
            margin-bottom: 15px;
        }

        .notification-actions {
            display: flex;
            gap: 10px;
        }

        .accept-btn {
            flex: 1;
            padding: 10px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .reject-btn {
            flex: 1;
            padding: 10px;
            background: #f56565;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        /* Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‡Ø§ØªÙ */
        .verification-container {
            text-align: center;
        }

        .phone-display {
            background: #f7fafc;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 600;
            color: #2d3748;
        }

        .verification-code {
            font-size: 1.5em;
            text-align: center;
            letter-spacing: 0.5em;
            margin-bottom: 20px;
        }

        .resend-timer {
            color: #718096;
            margin-bottom: 15px;
        }

        .resend-btn {
            background: transparent;
            color: #667eea;
            border: 1px solid #667eea;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .resend-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø­Ù…ÙˆÙ„ */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .map-sidebar {
                width: calc(100% - 20px);
                right: 10px;
                top: 10px;
                max-height: 50vh;
            }

            .chat-container {
                width: calc(100% - 20px);
                right: 10px;
                bottom: 10px;
            }

            .role-selection {
                grid-template-columns: 1fr;
            }
        }

        /* Ø¥Ø®ÙØ§Ø¡ reCAPTCHA */
        .grecaptcha-badge {
            visibility: hidden;
        }
    </style>
</head>
<body>
    <!-- ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div class="container">
<div id="loginPage" class="page active">
<div class="container">
    <div class="logo">
        <h1>ğŸ”</h1>
        <h1>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h1>
        <p>Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</p>
    </div>

    <div class="form-group">
        <label for="username">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
        <input type="text" id="username" placeholder="Ø§Ø®ØªØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" maxlength="20">
    </div>

    <div class="form-group">
        <label for="password">ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
        <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± (3 Ø£Ø±Ù‚Ø§Ù… Ùˆ3 Ø­Ø±ÙˆÙ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)">
    </div>

    <button class="btn" onclick="login()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>

    <div class="message" id="loginMessage"></div>
</div>

<!-- New login form will be inserted here -->

        <div id="verificationPage" class="page">
            <div class="logo">
                <h1>ğŸ”</h1>
                <h1>Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‡Ø§ØªÙ</h1>
                <p>Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù…Ø±Ø³Ù„ Ø¥Ù„Ù‰ Ù‡Ø§ØªÙÙƒ</p>
            </div>

            <div class="verification-container">
                <div class="phone-display" id="phoneDisplay"></div>

                <div class="form-group">
                    <label for="verificationCode">Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚</label>
                    <input type="text" id="verificationCode" class="verification-code" placeholder="000000" maxlength="6">
                </div>

                <button class="btn" onclick="verifyCode()">
                    âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±Ù…Ø²
                </button>

                <div class="resend-timer" id="resendTimer"></div>
                <button class="resend-btn" id="resendBtn" onclick="resendCode()" disabled>
                    ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²
                </button>

                <button class="btn" onclick="goBack()" style="background: #718096; margin-top: 10px;">
                    â† Ø§Ù„Ø¹ÙˆØ¯Ø©
                </button>
            </div>

            <div class="message" id="verificationMessage" style="display: none;"></div>
        </div>

        <!-- ØµÙØ­Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯ÙˆØ± -->
        <div id="roleSelectionPage" class="page">
            <div class="logo">
                <h1>ğŸ‘¤</h1>
                <h1>Ø§Ø®ØªØ± Ø¯ÙˆØ±Ùƒ</h1>
                <p>Ù‡Ù„ ØªØ±ÙŠØ¯ Ø£Ù† ØªÙƒÙˆÙ† Ø±Ø§ÙƒØ¨ Ø£Ù… Ø³Ø§Ø¦Ù‚ØŸ</p>
            </div>

            <div class="role-selection">
                <div class="role-card" onclick="selectRole('rakib')">
                    <div class="icon">ğŸ§â€â™€ï¸</div>
                    <h3>Ø±Ø§ÙƒØ¨</h3>
                    <p>Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø±Ø­Ù„Ø©</p>
                </div>
                <div class="role-card" onclick="selectRole('sayeq')">
                    <div class="icon">ğŸš—</div>
                    <h3>Ø³Ø§Ø¦Ù‚</h3>
                    <p>ØªÙˆÙÙŠØ± Ø±Ø­Ù„Ø§Øª</p>
                </div>
            </div>

            <div class="message" id="roleMessage" style="display: none;"></div>
        </div>

        <!-- ØµÙØ­Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ø§ÙƒØ¨ -->
        <div id="passengerInfoPage" class="page">
            <div class="logo">
                <h1>ğŸ§â€â™€ï¸</h1>
                <h1>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ø§ÙƒØ¨</h1>
                <p>Ø£Ø¯Ø®Ù„ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ø§Ù„Ø´Ø®ØµÙŠØ©</p>
            </div>

            <div class="form-group">
                <label for="passengerName">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                <input type="text" id="passengerName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„">
            </div>

            <div class="form-group">
                <label for="passengerAge">Ø§Ù„Ø¹Ù…Ø±</label>
                <input type="number" id="passengerAge" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ù…Ø±Ùƒ" min="16" max="80">
            </div>

            <div class="form-group">
                <label for="passengerGender">Ø§Ù„Ø¬Ù†Ø³</label>
                <select id="passengerGender">
                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù†Ø³</option>
                    <option value="male">Ø°ÙƒØ±</option>
                    <option value="female">Ø£Ù†Ø«Ù‰</option>
                </select>
            </div>

            <div class="form-group">
                <label for="passengerIdCard">ØµÙˆØ±Ø© Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù‡ÙˆÙŠØ©</label>
                <input type="file" id="passengerIdCard" accept="image/*">
            </div>

            <button class="btn" onclick="submitPassengerInfo()">
                âœ… Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
            </button>

            <div class="message" id="passengerMessage" style="display: none;"></div>
        </div>

        <!-- ØµÙØ­Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ -->
        <div id="driverInfoPage" class="page">
            <div class="logo">
                <h1>ğŸš—</h1>
                <h1>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚</h1>
                <p>Ø£Ø¯Ø®Ù„ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ ÙˆÙ…Ø¹Ù„ÙˆÙ…Ø§Øª Ø³ÙŠØ§Ø±ØªÙƒ</p>
            </div>

            <div class="form-group">
                <label for="driverName">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                <input type="text" id="driverName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„">
            </div>

            <div class="form-group">
                <label for="driverAge">Ø§Ù„Ø¹Ù…Ø±</label>
                <input type="number" id="driverAge" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ù…Ø±Ùƒ" min="18" max="70">
            </div>

            <div class="form-group">
                <label for="carType">Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label>
                <input type="text" id="carType" placeholder="Ù…Ø«Ø§Ù„: ØªÙˆÙŠÙˆØªØ§ ÙƒÙˆØ±ÙˆÙ„Ø§">
            </div>

            <div class="form-group">
                <label for="carColor">Ù„ÙˆÙ† Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label>
                <input type="text" id="carColor" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø¨ÙŠØ¶">
            </div>

            <div class="form-group">
                <label for="plateNumber">Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©</label>
                <input type="text" id="plateNumber" placeholder="Ù…Ø«Ø§Ù„: 123-456-78">
            </div>

            <div class="form-group">
                <label for="driverLicense">ØµÙˆØ±Ø© Ø±Ø®ØµØ© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</label>
                <input type="file" id="driverLicense" accept="image/*">
            </div>

            <div class="form-group">
                <label for="carRegistration">ØµÙˆØ±Ø© Ø±Ø®ØµØ© Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label>
                <input type="file" id="carRegistration" accept="image/*">
            </div>

            <div class="form-group">
                <input type="checkbox" id="driverDeclaration" style="width: auto; margin-left: 10px;">
                <label for="driverDeclaration" style="display: inline;">Ø£ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ <a href="#" onclick="showDeclaration()">Ø§Ù„ØªØ¹Ù‡Ø¯ ÙˆØ§Ù„Ø´Ø±ÙˆØ·</a></label>
            </div>

            <div id="declarationBox" style="display: none; background: #f7fafc; padding: 15px; border-radius: 10px; margin-bottom: 20px; font-size: 0.9em;"></div>

            <button class="btn" onclick="startDriverMap()">
                ğŸš— Ø¨Ø¯Ø¡ Ø§Ù„Ø®Ø¯Ù…Ø©
            </button>

            <div class="message" id="driverMessage" style="display: none;"></div>
        </div>
    </div>

    <!-- ØµÙØ­Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© -->
    <div id="mapPage" class="page">
        <div class="map-container">
            <div id="map"></div>
            
            <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ -->
            <div class="map-sidebar">
                <div class="sidebar-header">
                    <h3 id="sidebarTitle">ğŸ§â€â™€ï¸ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚</h3>
                    <button onclick="logout()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer;">Ø®Ø±ÙˆØ¬</button>
                </div>
                
                <div class="sidebar-content">
                    <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
                    <div class="user-info">
                        <div id="userWelcome">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ!</div>
                        <div id="userPhone" style="font-size: 0.9em; color: #718096;"></div>
                    </div>

                    <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø§ÙƒØ¨ -->
                    <div id="passengerContent">
                        <!-- Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…Ø³Ø§ÙØ© ÙˆØ§Ù„Ø³Ø¹Ø± -->
                        <div class="form-group">
                            <label for="distanceInput">Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø© (ÙƒÙ…)</label>
                            <input type="number" id="distanceInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø³Ø§ÙØ©" onchange="calculatePrice()">
                        </div>
                        
                        <div id="priceDisplay" style="display: none; background: #e6fffa; padding: 15px; border-radius: 10px; margin-bottom: 15px; text-align: center;">
                            <strong>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: <span id="calculatedPrice">0</span> Ø¯Ø¬</strong>
                            <div style="font-size: 0.8em; color: #718096; margin-top: 5px;">
                                â€¢ Ø£ÙˆÙ„ 20 ÙƒÙ…: 10 Ø¯Ø¬/ÙƒÙ…<br>
                                â€¢ Ù…Ù† 21-50 ÙƒÙ…: 5 Ø¯Ø¬/ÙƒÙ…<br>
                                â€¢ Ø£ÙƒØ«Ø± Ù…Ù† 50 ÙƒÙ…: 2 Ø¯Ø¬/ÙƒÙ…
                            </div>
                        </div>

                        <div id="tripStatus" class="trip-status" style="display: none;">
                            <div id="tripStatusText">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚...</div>
                        </div>

                        <button class="btn" id="activateBtn" onclick="activateRide()">
                            ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚
                        </button>

                        <button class="btn" id="cancelTripBtn" onclick="cancelTrip()" style="display: none; background: #f56565;">
                            âŒ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©
                        </button>

                        <div id="driversList"></div>
                    </div>

                    <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø³Ø§Ø¦Ù‚ -->
                    <div id="driverContent">
                        <div class="form-group">
                            <label for="driverStatus">Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚</label>
                            <select id="driverStatus" onchange="updateDriverStatus()">
                                <option value="available">Ù…ØªØ§Ø­</option>
                                <option value="busy">Ù…Ø´ØºÙˆÙ„</option>
                                <option value="offline">ØºÙŠØ± Ù…ØªØµÙ„</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="availableSeats">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ù…ØªØ§Ø­Ø©</label>
                            <select id="availableSeats">
                                <option value="1">1 Ù…Ù‚Ø¹Ø¯</option>
                                <option value="2">2 Ù…Ù‚Ø¹Ø¯</option>
                                <option value="3">3 Ù…Ù‚Ø§Ø¹Ø¯</option>
                                <option value="4" selected>4 Ù…Ù‚Ø§Ø¹Ø¯</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="driverNotes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</label>
                            <textarea id="driverNotes" placeholder="Ù…Ø«Ø§Ù„: Ù…ØªÙˆØ¬Ù‡ Ø¥Ù„Ù‰ ÙˆØ³Ø· Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©" rows="3"></textarea>
                        </div>

                        <button class="btn" onclick="activateRide()">
                            ğŸš— ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø©
                        </button>
                    </div>
                </div>
            </div>

            <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… -->
            <div class="map-controls">
                <button class="control-btn" onclick="centerOnUser()" title="Ù…ÙˆÙ‚Ø¹ÙŠ">ğŸ“</button>
                <button class="control-btn" onclick="toggleMapLayer()" title="ØªØºÙŠÙŠØ± Ø§Ù„Ø®Ø±ÙŠØ·Ø©">ğŸ—ºï¸</button>
            </div>
        </div>

        <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© -->
        <div id="chatContainer" class="chat-container">
            <div class="chat-header">
                <span id="chatTitle">Ø¯Ø±Ø¯Ø´Ø©</span>
                <button onclick="closeChat()" style="background: none; border: none; color: white; cursor: pointer;">âœ•</button>
            </div>
            <div id="chatMessages" class="chat-messages"></div>
            <div class="chat-input-container">
                <input type="text" id="chatInput" class="chat-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...">
                <button class="send-btn" onclick="sendMessage()">ğŸ“¤</button>
            </div>
        </div>
    </div>
        <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<script>
    // Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
    let currentUser = null;
    let currentRole = null;
    let currentMap = null;
    let currentMarker = null;
    let currentLocation = null;
    let driversMarkers = [];
    let passengersMarkers = [];
    let routeControl = null;
    let selectedDriver = null;
    let currentTripRequestId = null;
    let currentChatPartner = null;
    let confirmationResult = null;
    let resendTimer = null;
    let resendCountdown = 60;

    // Ø·Ø¨Ù‚Ø§Øª Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    const mapLayers = {
        osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }),
        satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Â© Esri'
        })
    };

    let currentMapLayer = mapLayers.osm;

    // Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    const driverIcon = L.icon({
        // ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯
    });

    const passengerIcon = L.icon({
        // ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯
    });

    // ========== Ù‡Ù†Ø§ Ø¶Ø¹ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ==========
    
    // ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±ÙŠ
    function validateAlgerianPhoneNumber(phoneNumber) {
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§ÙØ§Øª ÙˆØ§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
        const cleanNumber = phoneNumber.replace(/[\s\-\(\)]/g, '');
        
        // Ø£Ù†Ù…Ø§Ø· Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‡ÙˆØ§ØªÙ Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±ÙŠØ©
        const patterns = {
            // Djezzy (Ø¬ÙŠØ²ÙŠ)
            djezzy: /^(\+213|0)(77|78)[0-9]{7}$/,
            
            // Mobilis (Ù…ÙˆØ¨ÙŠÙ„ÙŠØ³)
            mobilis: /^(\+213|0)(55|56|66|67|69)[0-9]{7}$/,
            
            // Ooredoo (Ø£ÙˆØ±ÙŠØ¯Ùˆ)
            ooredoo: /^(\+213|0)(54|58|59)[0-9]{7}$/
        };
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†Ù…Ø§Ø·
        for (const [network, pattern] of Object.entries(patterns)) {
            if (pattern.test(cleanNumber)) {
                return {
                    isValid: true,
                    network: network,
                    formatted: formatPhoneNumber(cleanNumber)
                };
            }
        }
        
        return {
            isValid: false,
            network: null,
            formatted: null
        };
    }

    // ØªÙ†Ø³ÙŠÙ‚ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
    function formatPhoneNumber(phoneNumber) {
        const cleanNumber = phoneNumber.replace(/[\s\-\(\)]/g, '');
        
        // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¯ÙˆÙ„ÙŠ
        if (cleanNumber.startsWith('0')) {
            return '+213' + cleanNumber.substring(1);
        } else if (cleanNumber.startsWith('213')) {
            return '+' + cleanNumber;
        } else if (cleanNumber.startsWith('+213')) {
            return cleanNumber;
        }
        
        return '+213' + cleanNumber;
    }

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ø´Ø¨ÙƒØ©
    function getNetworkName(network) {
        const networks = {
            djezzy: 'Ø¬ÙŠØ²ÙŠ',
            mobilis: 'Ù…ÙˆØ¨ÙŠÙ„ÙŠØ³', 
            ooredoo: 'Ø£ÙˆØ±ÙŠØ¯Ùˆ'
        };
        return networks[network] || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
    }

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù…Ø² Ø§Ù„Ø´Ø¨ÙƒØ©
    function getNetworkEmoji(network) {
        const emojis = {
            djezzy: 'ğŸŸ¡',
            mobilis: 'ğŸ”µ',
            ooredoo: 'ğŸ”´'
        };
        return emojis[network] || 'ğŸ“±';
    }

    // Ø¹Ø±Ø¶ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø´Ø¨ÙƒØ©
    function showNetworkPreview(phoneNumber) {
        const validation = validateAlgerianPhoneNumber(phoneNumber);
        const previewDiv = document.getElementById('networkPreview');
        
        // Ø¥Ù†Ø´Ø§Ø¡ div Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
        if (!previewDiv) {
            const preview = document.createElement('div');
            preview.id = 'networkPreview';
            preview.style.cssText = `
                margin-top: 10px;
                padding: 8px 12px;
                border-radius: 6px;
                font-size: 12px;
                text-align: center;
                transition: all 0.3s ease;
            `;
            document.getElementById('phoneNumber').parentNode.appendChild(preview);
        }
        
        const preview = document.getElementById('networkPreview');
        
        if (validation.isValid) {
            preview.style.background = '#c6f6d5';
            preview.style.color = '#22543d';
            preview.style.border = '1px solid #9ae6b4';
            preview.innerHTML = `${getNetworkEmoji(validation.network)} ${getNetworkName(validation.network)}`;
            preview.style.display = 'block';
        } else if (phoneNumber.length > 3) {
            preview.style.background = '#fed7d7';
            preview.style.color = '#742a2a';
            preview.style.border = '1px solid #fc8181';
            preview.innerHTML = 'âŒ Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­';
            preview.style.display = 'block';
        } else {
            preview.style.display = 'none';
        }
    }

    // ØªØ­Ø¯ÙŠØ« Ù…Ø³ØªÙ…Ø¹ Ø­Ù‚Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
    document.addEventListener('DOMContentLoaded', function() {
    setupPhoneAuth();
        const phoneInput = document.getElementById('phoneNumber');
        if (phoneInput) {
            phoneInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, ''); // Ø¥Ø²Ø§Ù„Ø© ÙƒÙ„ Ø´ÙŠØ¡ Ø¹Ø¯Ø§ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
                
                // ØªÙ†Ø³ÙŠÙ‚ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø©
                if (value.startsWith('213')) {
                    value = '+' + value;
                } else if (value.startsWith('0')) {
                    // Ø¥Ø°Ø§ Ø¨Ø¯Ø£ Ø¨Ù€ 0ØŒ Ù†ØªØ±ÙƒÙ‡ ÙƒÙ…Ø§ Ù‡Ùˆ Ù„Ù„Ø¢Ù†
                    value = value;
                } else if (value.length > 0 && !value.startsWith('0')) {
                    // Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 0 Ø£Ùˆ 213ØŒ Ù†Ø¶ÙŠÙ 0
                    value = '0' + value;
                }
                
                // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø·ÙˆÙ„
                if (value.startsWith('+213')) {
                    value = value.substring(0, 13); // +213xxxxxxxxx
                } else if (value.startsWith('0')) {
                    value = value.substring(0, 10); // 0xxxxxxxxx
                }
                
                e.target.value = value;
                
                // Ø¹Ø±Ø¶ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø´Ø¨ÙƒØ©
                showNetworkPreview(value);
            });

            phoneInput.addEventListener('blur', function(e) {
                // ØªÙ†Ø³ÙŠÙ‚ Ù†Ù‡Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ÙÙ‚Ø¯Ø§Ù† Ø§Ù„ØªØ±ÙƒÙŠØ²
                const value = e.target.value.trim();
                if (value) {
                    const validation = validateAlgerianPhoneNumber(value);
                    if (validation.isValid) {
                        e.target.value = validation.formatted;
                    }
                }
            });
        }
    });

    // ========== Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ==========

function isValidPassword(password) {
    const hasLetters = (password.match(/[a-zA-Z\u0621-\u064A]/g) || []).length >= 3;
    const hasDigits = (password.match(/[0-9]/g) || []).length >= 3;
    return password.length >= 6 && hasLetters && hasDigits;
}

async function login() {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();

    if (!username || !password) {
        showMessage('error', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±', 'login');
        return;
    }

    if (!isValidPassword(password)) {
        showMessage('error', 'ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ 3 Ø£Ø­Ø±Ù Ùˆ3 Ø£Ø±Ù‚Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'login');
        return;
    }

    const userRef = window.ref(window.db, `users/${username}`);
    const snapshot = await window.get(userRef);

    if (snapshot.exists()) {
        const userData = snapshot.val();
        if (userData.password === password) {
            currentUser = { uid: username, ...userData };
            currentRole = userData.role;
            showMessage('success', 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!', 'login');
            setTimeout(() => {
                showPage('mapPage');
                loadMap(userData.name || username);
            }, 1000);
        } else {
            showMessage('error', 'ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'login');
        }
    } else {
        currentUser = { uid: username, password: password };
        localStorage.setItem('tempPassword', password);
        showPage('roleSelectionPage');
    }
}

function selectRole(role) {
    document.querySelectorAll('.role-card').forEach(card => {
        card.classList.remove('selected');
    });
    event.target.closest('.role-card').classList.add('selected');
    currentRole = role;

    if (role === 'rakib') {
        showPage('passengerInfoPage');
    } else {
        showPage('driverInfoPage');
    }
}

function submitPassengerInfo() {
    const name = document.getElementById('passengerName').value.trim();
    const age = document.getElementById('passengerAge').value;
    const gender = document.getElementById('passengerGender').value;
    const idCard = document.getElementById('passengerIdCard').files[0];

    if (!name || !age || !gender || !idCard) {
        showMessage('error', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'passenger');
        return;
    }
    if (age < 16 || age > 80) {
        showMessage('error', 'Ø§Ù„Ø¹Ù…Ø± ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨ÙŠÙ† 16 Ùˆ 80 Ø³Ù†Ø©', 'passenger');
        return;
    }

    window.set(window.ref(window.db, `users/${currentUser.uid}`), {
        name, age: parseInt(age), gender,
        role: 'rakib',
        password: localStorage.getItem('tempPassword'),
        profileComplete: true,
        registeredAt: Date.now()
    }).then(() => {
        showMessage('success', 'ØªÙ… Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­!', 'passenger');
        setTimeout(() => {
            showPage('mapPage');
            loadMap(name);
        }, 1000);
    });
}

function startDriverMap() {
    const name = document.getElementById('driverName').value.trim();
    const age = document.getElementById('driverAge').value;
    const carType = document.getElementById('carType').value.trim();
    const carColor = document.getElementById('carColor').value.trim();
    const plateNumber = document.getElementById('plateNumber').value.trim();
    const driverLicense = document.getElementById('driverLicense').files[0];
    const carRegistration = document.getElementById('carRegistration').files[0];
    const declaration = document.getElementById('driverDeclaration').checked;

    if (!name || !age || !carType || !carColor || !plateNumber || !driverLicense || !carRegistration || !declaration) {
        showMessage('error', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙˆØ§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„ØªØ¹Ù‡Ø¯', 'driver');
        return;
    }
    if (age < 18 || age > 70) {
        showMessage('error', 'Ø§Ù„Ø¹Ù…Ø± ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨ÙŠÙ† 18 Ùˆ 70 Ø³Ù†Ø©', 'driver');
        return;
    }

    window.set(window.ref(window.db, `users/${currentUser.uid}`), {
        name, age: parseInt(age), carType, carColor, plateNumber,
        role: 'sayeq',
        password: localStorage.getItem('tempPassword'),
        profileComplete: true,
        registeredAt: Date.now()
    }).then(() => {
        showMessage('success', 'ØªÙ… Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­!', 'driver');
        setTimeout(() => {
            showPage('mapPage');
            loadMap(name);
        }, 1000);
    });
}


    // Ø¥Ø¹Ø¯Ø§Ø¯ Firebase Auth Ù„Ù„Ù‡Ø§ØªÙ
    

    // ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ (Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©)
    

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±ÙŠ
        const validation = validateAlgerianPhoneNumber(phoneNumber);
        
        if (!validation.isValid) {
            showMessage('error', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø¬Ø²Ø§Ø¦Ø±ÙŠ ØµØ­ÙŠØ­\n(Ø¬ÙŠØ²ÙŠ: 077/078ØŒ Ù…ÙˆØ¨ÙŠÙ„ÙŠØ³: 055/056/066/067/069ØŒ Ø£ÙˆØ±ÙŠØ¯Ùˆ: 054/058/059)', 'login');
            return;
        }

        // ØªØ­Ø¯ÙŠØ« Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØµØ­ÙŠØ­
        phoneInput.value = validation.formatted;

        try {
            showMessage('info', `Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ù„Ù‰ ${getNetworkName(validation.network)}...`, 'login');
            
            if (!window.recaptchaVerifier) {
                setupPhoneAuth();
            }

            confirmationResult = await window.signInWithPhoneNumber(window.auth, validation.formatted, window.recaptchaVerifier);
            
            document.getElementById('phoneDisplay').innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 16px; font-weight: bold;">${validation.formatted}</div>
                    <div style="font-size: 12px; color: #667eea; margin-top: 5px;">
                        ${getNetworkName(validation.network)} ${getNetworkEmoji(validation.network)}
                    </div>
                </div>
            `;
            
            showPage('verificationPage');
            startResendTimer();
            showMessage('success', `ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ù„Ù‰ ${getNetworkName(validation.network)} Ø¨Ù†Ø¬Ø§Ø­!`, 'verification');
            
        } catch (error) {
            console.error('Error sending verification code:', error);
            let errorMessage = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚';
            
            switch (error.code) {
                case 'auth/invalid-phone-number':
                    errorMessage = 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­';
                    break;
                case 'auth/too-many-requests':
                    errorMessage = 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¯Ø¯ ÙƒØ¨ÙŠØ± Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ø§Ù‹';
                    break;
                case 'auth/quota-exceeded':
                    errorMessage = 'ØªÙ… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ù…Ù† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙŠÙˆÙ…';
                    break;
                case 'auth/api-key-not-valid':
                    errorMessage = 'Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹';
                    break;
            }
            
            showMessage('error', errorMessage, 'login');
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† reCAPTCHA
            if (window.recaptchaVerifier) {
                window.recaptchaVerifier.clear();
                setupPhoneAuth();
            }
        }
    }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù…Ø²
        

            if (!confirmationResult) {
                showMessage('error', 'Ø­Ø¯Ø« Ø®Ø·Ø£. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚', 'verification');
                return;
            }

            try {
                showMessage('info', 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù…Ø²...', 'verification');
                
                const result = await confirmationResult.confirm(code);
                currentUser = result.user;
                
                // Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                const userData = {
                    uid: currentUser.uid,
                    phoneNumber: currentUser.phoneNumber,
                    lastLogin: Date.now()
                };

                await window.set(window.ref(window.db, `users/${currentUser.uid}`), userData);
                
                showMessage('success', 'ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­!', 'verification');
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                const userSnapshot = await window.get(window.ref(window.db, `users/${currentUser.uid}`));
                const existingData = userSnapshot.val();
                
                if (existingData && existingData.role) {
                    // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹
                    currentRole = existingData.role;
                    showPage('mapPage');
                    loadMap(existingData.name || currentUser.phoneNumber);
                } else {
                    // Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
                    setTimeout(() => {
                        showPage('roleSelectionPage');
                    }, 1500);
                }
                
            } catch (error) {
                console.error('Error verifying code:', error);
                let errorMessage = 'Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ ØºÙŠØ± ØµØ­ÙŠØ­';
                
                switch (error.code) {
                    case 'auth/invalid-verification-code':
                        errorMessage = 'Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ ØºÙŠØ± ØµØ­ÙŠØ­';
                        break;
                    case 'auth/code-expired':
                        errorMessage = 'Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚. ÙŠØ±Ø¬Ù‰ Ø·Ù„Ø¨ Ø±Ù…Ø² Ø¬Ø¯ÙŠØ¯';
                        break;
                }
                
                showMessage('error', errorMessage, 'verification');
            }
        }

        // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²
        
                setupPhoneAuth();

                confirmationResult = await window.signInWithPhoneNumber(window.auth, phoneNumber, window.recaptchaVerifier);
                
                showMessage('success', 'ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚!', 'verification');
                startResendTimer();
                
            } catch (error) {
                console.error('Error resending code:', error);
                showMessage('error', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²', 'verification');
            }
        }

        // Ø¨Ø¯Ø¡ Ø¹Ø¯Ø§Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
         Ø«Ø§Ù†ÙŠØ©`;
                
                if (resendCountdown <= 0) {
                    clearInterval(resendTimer);
                    resendBtn.disabled = false;
                    timerDiv.textContent = '';
                }
            }, 1000);
        }

        // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        
            showPage('loginPage');
        }

        // Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø§Øª
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
        }

        // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        function showMessage(type, message, context = '') {
            const messageId = context ? `${context}Message` : 'message';
            const messageDiv = document.getElementById(messageId);
            
            if (messageDiv) {
                messageDiv.className = `message ${type}`;
                messageDiv.textContent = message;
                messageDiv.style.display = 'block';
                
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 5000);
            }
        }

        // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯ÙˆØ±
        function selectRole(role) {
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚
            document.querySelectorAll('.role-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯
            event.target.closest('.role-card').classList.add('selected');
            currentRole = role;
            
            setTimeout(() => {
                if (role === 'rakib') {
                    showPage('passengerInfoPage');
                } else {
                    showPage('driverInfoPage');
                }
            }, 500);
        }

        // ØªØ¨Ø¯ÙŠÙ„ Ø·Ø¨Ù‚Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø©
        function toggleMapLayer() {
            if (currentMapLayer === mapLayers.osm) {
                currentMap.removeLayer(currentMapLayer);
                currentMapLayer = mapLayers.satellite;
                currentMapLayer.addTo(currentMap);
            } else {
                currentMap.removeLayer(currentMapLayer);
                currentMapLayer = mapLayers.osm;
                currentMapLayer.addTo(currentMap);
            }
        }

        // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        function centerOnUser() {
            if (currentLocation && currentMap) {
                currentMap.setView([currentLocation.lat, currentLocation.lng], 16);
            }
        }

        // Ø­Ø³Ø§Ø¨ Ø«Ù…Ù† Ø§Ù„Ù…Ø³Ø§ÙØ©
        function calculatePrice() {
            const distance = parseFloat(document.getElementById('distanceInput').value);
            if (!distance || distance <= 0) {
                document.getElementById('priceDisplay').style.display = 'none';
                return;
            }

            let totalPrice = 0;

            if (distance <= 20) {
                totalPrice = distance * 10;
            } else if (distance <= 50) {
                totalPrice = (20 * 10) + ((distance - 20) * 5);
            } else {
                totalPrice = (20 * 10) + (30 * 5) + ((distance - 50) * 2);
            }

            document.getElementById('calculatedPrice').textContent = totalPrice;
            document.getElementById('priceDisplay').style.display = 'block';
        }

        function loadMap(userName) {
            if (currentMap) {
                currentMap.remove();
            }

            currentMap = L.map('map').setView([28.0339, 1.6596], 6);

            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø¨Ù‚Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            currentMapLayer = mapLayers.osm;
            currentMapLayer.addTo(currentMap);

            // Ø¹Ø±Ø¶ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
            document.getElementById('userPhone').textContent = currentUser.phoneNumber;

            // ØªØ®ØµÙŠØµ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            if (currentRole === 'rakib') {
                document.getElementById('passengerContent').style.display = 'block';
                document.getElementById('driverContent').style.display = 'none';
                document.getElementById('sidebarTitle').textContent = 'ğŸ§â€â™€ï¸ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚';
                document.getElementById('activateBtn').textContent = 'ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚';
                document.getElementById('userWelcome').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${userName}`;
            } else {
                document.getElementById('passengerContent').style.display = 'none';
                document.getElementById('driverContent').style.display = 'block';
                document.getElementById('sidebarTitle').textContent = 'ğŸš— Ù„ÙˆØ­Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚';
                document.getElementById('activateBtn').textContent = 'ğŸš— ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø©';
                document.getElementById('userWelcome').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${userName}`;
            }

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    currentLocation = { lat, lng };

                    currentMap.setView([lat, lng], 14);

                    if (currentMarker) {
                        currentMap.removeLayer(currentMarker);
                    }

                    const icon = currentRole === 'rakib' ? passengerIcon : driverIcon;
                    currentMarker = L.marker([lat, lng], { icon }).addTo(currentMap)
                        .bindPopup(`ğŸ“ ${userName}`)
                        .openPopup();

                    // Ø¨Ø¯Ø¡ ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹
                    startLocationTracking();
                }, (error) => {
                    console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹:", error);
                    alert("âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹.");
                });
            } else {
                alert("âš ï¸ Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.");
            }
        }

        // ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
        function startLocationTracking() {
            if (!currentUser) return;

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙƒÙ„ 10 Ø«ÙˆØ§Ù†
            setInterval(() => {
                if (navigator.geolocation && currentLocation) {
                    navigator.geolocation.getCurrentPosition(position => {
                        const newLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            role: currentRole,
                            name: currentUser.displayName || currentUser.phoneNumber,
                            phoneNumber: currentUser.phoneNumber,
                            timestamp: Date.now(),
                            status: currentRole === 'sayeq' ? (document.getElementById('driverStatus')?.value || 'available') : 'active'
                        };

                        // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø³Ø§Ø¦Ù‚Ø§Ù‹
                        if (currentRole === 'sayeq') {
                            const driverData = JSON.parse(localStorage.getItem('driverData') || '{}');
                            newLocation.carType = driverData.carType || '';
                            newLocation.carColor = driverData.carColor || '';
                            newLocation.plateNumber = driverData.plateNumber || '';
                            newLocation.availableSeats = document.getElementById('availableSeats')?.value || 4;
                            newLocation.notes = document.getElementById('driverNotes')?.value || '';
                        }

                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Firebase
                        window.set(window.ref(window.db, `locations/${currentUser.uid}`), newLocation);

                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø­Ù„ÙŠ
                        currentLocation = { lat: newLocation.lat, lng: newLocation.lng };

                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
                        if (currentMarker) {
                            currentMarker.setLatLng([newLocation.lat, newLocation.lng]);
                        }
                    });
                }
            }, 10000);

            // Ù…Ø±Ø§Ù‚Ø¨Ø© Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†
            if (currentRole === 'rakib') {
                watchDrivers();
            } else {
                watchPassengers();
            }

            // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø§Øª
            watchTripRequests();
        }

        // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ù„Ù„Ø±ÙƒØ§Ø¨
        function watchDrivers() {
            const driversRef = window.ref(window.db, 'locations');
            window.onValue(driversRef, (snapshot) => {
                const locations = snapshot.val();
                updateDriversOnMap(locations);
                updateDriversList(locations);
            });
        }

        // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø±ÙƒØ§Ø¨ Ù„Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†
        function watchPassengers() {
            const passengersRef = window.ref(window.db, 'locations');
            window.onValue(passengersRef, (snapshot) => {
                const locations = snapshot.val();
                updatePassengersOnMap(locations);
            });
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
        function updateDriversOnMap(locations) {
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
            driversMarkers.forEach(marker => currentMap.removeLayer(marker));
            driversMarkers = [];

            if (!locations) return;

            Object.keys(locations).forEach(userId => {
                const location = locations[userId];
                if (location.role === 'sayeq' && location.status === 'available' && userId !== currentUser?.uid) {
                    const marker = L.marker([location.lat, location.lng], { icon: driverIcon })
                        .addTo(currentMap);

                    // Ø¥Ù†Ø´Ø§Ø¡ popup Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„ÙƒØ§Ù…Ù„Ø©
                    const popupContent = `
                        <div class="driver-popup">
                            <h4>ğŸš— ${location.name}</h4>
                            <p><strong>ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${location.phoneNumber || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</p>
                            <p><strong>ğŸš™ Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©:</strong> ${location.carType || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                            <p><strong>ğŸ¨ Ù„ÙˆÙ† Ø§Ù„Ø³ÙŠØ§Ø±Ø©:</strong> ${location.carColor || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                            <p><strong>ğŸ”¢ Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©:</strong> ${location.plateNumber || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</p>
                            <p><strong>ğŸ’º Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ù…ØªØ§Ø­Ø©:</strong> ${location.availableSeats || 4}</p>
                            ${location.notes ? `<p><strong>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${location.notes}</p>` : ''}
                        </div>
                    `;

                    marker.bindPopup(popupContent);
                    marker.userId = userId;
                    driversMarkers.push(marker);
                }
            });
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ÙƒØ§Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
        function updatePassengersOnMap(locations) {
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
            passengersMarkers.forEach(marker => currentMap.removeLayer(marker));
            passengersMarkers = [];

            if (!locations) return;

            Object.keys(locations).forEach(userId => {
                const location = locations[userId];
                if (location.role === 'rakib' && userId !== currentUser?.uid) {
                    const marker = L.marker([location.lat, location.lng], { icon: passengerIcon })
                        .addTo(currentMap);

                    const popupContent = `
                        <div class="driver-popup">
                            <h4>ğŸ§â€â™€ï¸ ${location.name}</h4>
                            <p><strong>ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${location.phoneNumber}</p>
                            <p><strong>ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹:</strong> Ø±Ø§ÙƒØ¨ ÙŠØ¨Ø­Ø« Ø¹Ù† Ø±Ø­Ù„Ø©</p>
                        </div>
                    `;

                    marker.bindPopup(popupContent);
                    marker.userId = userId;
                    passengersMarkers.push(marker);
                }
            });
        }

        // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†
        function updateDriversList(locations) {
            const driversList = document.getElementById('driversList');
            if (!driversList) return;

            driversList.innerHTML = '';

            if (!locations || !currentLocation) return;

            const availableDrivers = [];

            Object.keys(locations).forEach(userId => {
                const location = locations[userId];
                if (location.role === 'sayeq' && location.status === 'available' && userId !== currentUser?.uid) {
                    const distance = calculateDistance(currentLocation.lat, currentLocation.lng, location.lat, location.lng);
                    availableDrivers.push({ ...location, userId, distance });
                }
            });

            // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©
            availableDrivers.sort((a, b) => a.distance - b.distance);

            availableDrivers.forEach(driver => {
                const driverCard = document.createElement('div');
                driverCard.className = 'driver-card';
                driverCard.innerHTML = `
                    <div class="driver-info">
                        <span class="driver-name">ğŸš— ${driver.name}</span>
                        <span class="driver-distance">${driver.distance.toFixed(1)} ÙƒÙ…</span>
                    </div>
                    <div class="car-info">
                        ğŸš™ ${driver.carType || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} - ğŸ¨ ${driver.carColor || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
                        <br>ğŸ’º ${driver.availableSeats || 4} Ù…Ù‚Ø§Ø¹Ø¯ Ù…ØªØ§Ø­Ø©
                        ${driver.notes ? `<br>ğŸ“ ${driver.notes}` : ''}
                    </div>
                    <div class="driver-actions">
                        <button class="action-btn call-btn" onclick="callDriver('${driver.phoneNumber}')">ğŸ“ Ø§ØªØµØ§Ù„</button>
                        <button class="action-btn chat-btn" onclick="startChat('${driver.userId}', '${driver.name}')">ğŸ’¬ Ø¯Ø±Ø¯Ø´Ø©</button>
                        <button class="action-btn select-btn" onclick="selectDriver('${driver.userId}')">âœ… Ø§Ø®ØªÙŠØ§Ø±</button>
                    </div>
                `;
                driversList.appendChild(driverCard);
            });

            if (availableDrivers.length === 0) {
                driversList.innerHTML = '<p style="text-align: center; color: #718096;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø§Ø¦Ù‚ÙˆÙ† Ù…ØªØ§Ø­ÙˆÙ† ÙÙŠ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</p>';
            }
        }

        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ù†Ù‚Ø·ØªÙŠÙ†
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Ù†ØµÙ Ù‚Ø·Ø± Ø§Ù„Ø£Ø±Ø¶ Ø¨Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³Ø§Ø¦Ù‚
        function callDriver(phoneNumber) {
            if (phoneNumber && phoneNumber !== 'ØºÙŠØ± Ù…ØªÙˆÙØ±') {
                window.open(`tel:${phoneNumber}`, '_self');
            } else {
                alert('Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± Ù…ØªÙˆÙØ±');
            }
        }

        // Ø¨Ø¯Ø¡ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
        function startChat(userId, userName) {
            currentChatPartner = { userId, userName };
            document.getElementById('chatTitle').textContent = `Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹ ${userName}`;
            document.getElementById('chatContainer').style.display = 'flex';
            loadChatMessages(userId);
        }

        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
        function closeChat() {
            document.getElementById('chatContainer').style.display = 'none';
            currentChatPartner = null;
        }

        // ØªØ­Ù…ÙŠÙ„ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
        function loadChatMessages(partnerId) {
            const chatId = [currentUser.uid, partnerId].sort().join('_');
            const messagesRef = window.ref(window.db, `chats/${chatId}/messages`);

            window.onValue(messagesRef, (snapshot) => {
                const messages = snapshot.val();
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = '';

                if (messages) {
                    Object.keys(messages).forEach(messageId => {
                        const message = messages[messageId];
                        const messageDiv = document.createElement('div');
                        messageDiv.className = `message ${message.senderId === currentUser.uid ? 'sent' : 'received'}`;
                        messageDiv.textContent = message.text;
                        chatMessages.appendChild(messageDiv);
                    });
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            });
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
        function sendMessage() {
            const chatInput = document.getElementById('chatInput');
            const messageText = chatInput.value.trim();

            if (!messageText || !currentChatPartner) return;

            const chatId = [currentUser.uid, currentChatPartner.userId].sort().join('_');
            const messagesRef = window.ref(window.db, `chats/${chatId}/messages`);

            window.push(messagesRef, {
                text: messageText,
                senderId: currentUser.uid,
                senderName: currentUser.displayName || currentUser.phoneNumber,
                timestamp: Date.now()
            });

            chatInput.value = '';
        }

        // Ø§Ø®ØªÙŠØ§Ø± Ø³Ø§Ø¦Ù‚
        function selectDriver(driverId) {
            selectedDriver = driverId;
        // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø±Ø­Ù„Ø© Ù„Ù„Ø³Ø§Ø¦Ù‚
        const tripRequest = {
            passengerId: currentUser.uid,
            passengerName: currentUser.displayName || currentUser.phoneNumber,
            passengerPhone: currentUser.phoneNumber,
            driverId: driverId,
            passengerLocation: currentLocation,
            status: 'pending',
            timestamp: Date.now()
        };

        window.push(window.ref(window.db, 'tripRequests'), tripRequest)
        .then((ref) => {
            currentTripRequestId = ref.key;
            showNotification('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø±Ø­Ù„Ø©', 'ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚...', 'info');
        });
    }

    // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©
    function cancelTrip() {
        if (currentTripRequestId) {
            // Ø¥Ù„ØºØ§Ø¡ Ø·Ù„Ø¨ Ø§Ù„Ø±Ø­Ù„Ø©
            window.update(window.ref(window.db, `tripRequests/${currentTripRequestId}`), {
                status: 'cancelled',
                cancelledAt: Date.now(),
                cancelledBy: currentUser.uid
            });

            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§Ø± Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø©
            if (routeControl) {
                currentMap.removeControl(routeControl);
                routeControl = null;
            }

            // Ø¥Ø®ÙØ§Ø¡ Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø­Ù„Ø©
            document.getElementById('tripStatus').style.display = 'none';
            document.getElementById('cancelTripBtn').style.display = 'none';

            currentTripRequestId = null;
            selectedDriver = null;

            showNotification('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©', 'ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚ Ø¢Ø®Ø±', 'info');
        }
    }

    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø§Øª
    function watchTripRequests() {
        const requestsRef = window.ref(window.db, 'tripRequests');
        window.onValue(requestsRef, (snapshot) => {
            const requests = snapshot.val();
            if (!requests) return;

            Object.keys(requests).forEach(requestId => {
                const request = requests[requestId];

                // Ù„Ù„Ø³Ø§Ø¦Ù‚: Ø¹Ø±Ø¶ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©
                if (currentRole === 'sayeq' && request.driverId === currentUser.uid && request.status === 'pending') {
                    showTripRequestNotification(request, requestId);
                }

                // Ù„Ù„Ø±Ø§ÙƒØ¨: Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨
                if (currentRole === 'rakib' && request.passengerId === currentUser.uid) {
                    updateTripStatus(request, requestId);
                }
            });
        });
    }

    // Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø± Ø·Ù„Ø¨ Ø§Ù„Ø±Ø­Ù„Ø© Ù„Ù„Ø³Ø§Ø¦Ù‚
    function showTripRequestNotification(request, requestId) {
        // ØªØ¬Ù†Ø¨ Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…ØªÙƒØ±Ø±Ø©
        if (document.querySelector(`[data-request-id="${requestId}"]`)) return;

        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.setAttribute('data-request-id', requestId);
        notification.innerHTML = `
            <div class="notification-title">ğŸš— Ø·Ù„Ø¨ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯</div>
            <div class="notification-content">
                Ø§Ù„Ø±Ø§ÙƒØ¨: ${request.passengerName}<br>
                Ø§Ù„Ù‡Ø§ØªÙ: ${request.passengerPhone}<br>
                Ø§Ù„Ù…Ø³Ø§ÙØ©: ${calculateDistance(currentLocation.lat, currentLocation.lng, request.passengerLocation.lat, request.passengerLocation.lng).toFixed(1)} ÙƒÙ…
            </div>
            <div class="notification-actions">
                <button class="accept-btn" onclick="acceptTrip('${requestId}')">Ù‚Ø¨ÙˆÙ„</button>
                <button class="reject-btn" onclick="rejectTrip('${requestId}')">Ø±ÙØ¶</button>
            </div>
        `;
        document.body.appendChild(notification);

        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø¹Ø¯ 30 Ø«Ø§Ù†ÙŠØ©
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 30000);
    }

    // Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©
    function acceptTrip(requestId) {
        window.update(window.ref(window.db, `tripRequests/${requestId}`), {
            status: 'accepted',
            acceptedAt: Date.now()
        });

        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
        const notification = document.querySelector(`[data-request-id="${requestId}"]`);
        if (notification && notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }

        showNotification('ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©', 'ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø±Ø§ÙƒØ¨', 'success');

        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¥Ù„Ù‰ Ù…Ø´ØºÙˆÙ„
        document.getElementById('driverStatus').value = 'busy';
        updateDriverStatus();
    }

    // Ø±ÙØ¶ Ø§Ù„Ø±Ø­Ù„Ø©
    function rejectTrip(requestId) {
        window.update(window.ref(window.db, `tripRequests/${requestId}`), {
            status: 'rejected',
            rejectedAt: Date.now()
        });

        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
        const notification = document.querySelector(`[data-request-id="${requestId}"]`);
        if (notification && notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø­Ù„Ø© Ù„Ù„Ø±Ø§ÙƒØ¨
    function updateTripStatus(request, requestId) {
        const statusDiv = document.getElementById('tripStatus');
        const statusText = document.getElementById('tripStatusText');
        const cancelBtn = document.getElementById('cancelTripBtn');

        if (request.status === 'pending') {
            statusDiv.style.display = 'block';
            statusText.textContent = 'â³ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚...';
            statusDiv.className = 'trip-status';
            cancelBtn.style.display = 'block';
            currentTripRequestId = requestId;
        } else if (request.status === 'accepted') {
            statusDiv.style.display = 'block';
            statusText.textContent = 'âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚';
            statusDiv.className = 'trip-status active';
            cancelBtn.style.display = 'block';
            currentTripRequestId = requestId;

            // Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø§Ø¦Ù‚
            drawRouteToDriver(request.driverId);
        } else if (request.status === 'rejected') {
            statusDiv.style.display = 'block';
            statusText.textContent = 'âŒ ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø±Ø­Ù„Ø©. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚ Ø¢Ø®Ø±';
            statusDiv.className = 'trip-status';
            cancelBtn.style.display = 'none';
            currentTripRequestId = null;
        } else if (request.status === 'cancelled') {
            statusDiv.style.display = 'none';
            cancelBtn.style.display = 'none';
            currentTripRequestId = null;
        }
    }

    // Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø§Ø¦Ù‚
    function drawRouteToDriver(driverId) {
        const driversRef = window.ref(window.db, `locations/${driverId}`);
        window.get(driversRef).then((snapshot) => {
            if (snapshot.exists()) {
                const driverLocation = snapshot.val();

                // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¥Ù† ÙˆØ¬Ø¯
                if (routeControl) {
                    currentMap.removeControl(routeControl);
                }

                // Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
                routeControl = L.Routing.control({
                    waypoints: [
                        L.latLng(currentLocation.lat, currentLocation.lng),
                        L.latLng(driverLocation.lat, driverLocation.lng)
                    ],
                    routeWhileDragging: false,
                    addWaypoints: false,
                    createMarker: function() { return null; }, // Ù„Ø§ Ù†Ø±ÙŠØ¯ Ø¹Ù„Ø§Ù…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
                    lineOptions: {
                        styles: [{ color: '#667eea', weight: 4, opacity: 0.7 }]
                    }
                }).addTo(currentMap);
            }
        });
    }

    // Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø±
    function showNotification(title, content, type) {
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.innerHTML = `
            <div class="notification-title">${title}</div>
            <div class="notification-content">${content}</div>
        `;
        document.body.appendChild(notification);

        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 5000);
    }

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚
    function updateDriverStatus() {
        const status = document.getElementById('driverStatus').value;
        if (currentUser && currentLocation) {
            window.update(window.ref(window.db, `locations/${currentUser.uid}`), {
                status: status
            });
        }
    }

    // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø©
    function activateRide() {
        if (currentRole === 'rakib') {
            // Ù„Ù„Ø±Ø§ÙƒØ¨: Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚
            showMessage('success', 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ø§Ù„Ù…ØªØ§Ø­ÙŠÙ†...');
        } else {
            // Ù„Ù„Ø³Ø§Ø¦Ù‚: ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø©
            const status = document.getElementById('driverStatus').value;
            if (status === 'available') {
                showMessage('success', 'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø®Ø¯Ù…Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¨Ù†Ø¬Ø§Ø­!');
            } else {
                showMessage('error', 'ÙŠØ¬Ø¨ ØªØºÙŠÙŠØ± Ø­Ø§Ù„ØªÙƒ Ø¥Ù„Ù‰ "Ù…ØªØ§Ø­" Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø©');
            }
        }
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ø§ÙƒØ¨
    function submitPassengerInfo() {
        const name = document.getElementById('passengerName').value.trim();
        const age = document.getElementById('passengerAge').value;
        const gender = document.getElementById('passengerGender').value;
        const idCard = document.getElementById('passengerIdCard').files[0];

        if (!name || !age || !gender || !idCard) {
            showMessage('error', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'passenger');
            return;
        }

        if (age < 16 || age > 80) {
            showMessage('error', 'Ø§Ù„Ø¹Ù…Ø± ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨ÙŠÙ† 16 Ùˆ 80 Ø³Ù†Ø©', 'passenger');
            return;
        }

        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹
        localStorage.setItem('passengerData', JSON.stringify({ name, age, gender }));

        // Ø­ÙØ¸ ÙÙŠ Firebase
        window.update(window.ref(window.db, `users/${currentUser.uid}`), {
            name: name,
            age: parseInt(age),
            gender: gender,
            role: 'rakib',
            phoneNumber: currentUser.phoneNumber,
            profileComplete: true,
            registeredAt: Date.now()
        }).then(() => {
            showMessage('success', 'ØªÙ… Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­!', 'passenger');
            setTimeout(() => {
                showPage("mapPage");
                loadMap(name);
            }, 2000);
        }).catch((error) => {
            console.error('Error saving passenger data:', error);
            showMessage('error', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'passenger');
        });
    }

    // Ø¨Ø¯Ø¡ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚
    function startDriverMap() {
        const name = document.getElementById('driverName').value.trim();
        const age = document.getElementById('driverAge').value;
        const carType = document.getElementById('carType').value.trim();
        const carColor = document.getElementById('carColor').value.trim();
        const plateNumber = document.getElementById('plateNumber').value.trim();
        const driverLicense = document.getElementById('driverLicense').files[0];
        const carRegistration = document.getElementById('carRegistration').files[0];
        const declaration = document.getElementById('driverDeclaration').checked;

        if (!name || !age || !carType || !carColor || !plateNumber || !driverLicense || !carRegistration || !declaration) {
            showMessage('error', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙˆØ§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„ØªØ¹Ù‡Ø¯', 'driver');
            return;
        }

        if (age < 18 || age > 70) {
            showMessage('error', 'Ø§Ù„Ø¹Ù…Ø± ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨ÙŠÙ† 18 Ùˆ 70 Ø³Ù†Ø©', 'driver');
            return;
        }

        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹
        localStorage.setItem('driverData', JSON.stringify({
            name, age, carType, carColor, plateNumber
        }));

        // Ø­ÙØ¸ ÙÙŠ Firebase
        window.update(window.ref(window.db, `users/${currentUser.uid}`), {
            name: name,
            age: parseInt(age),
            carType: carType,
            carColor: carColor,
            plateNumber: plateNumber,
            role: 'sayeq',
            phoneNumber: currentUser.phoneNumber,
            profileComplete: true,
            registeredAt: Date.now()
        }).then(() => {
            showMessage('success', 'ØªÙ… Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­!', 'driver');
            setTimeout(() => {
                showPage("mapPage");
                loadMap(name);
            }, 2000);
        }).catch((error) => {
            console.error('Error saving driver data:', error);
            showMessage('error', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'driver');
        });
    }

    // Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ù‡Ø¯
    function showDeclaration() {
        const declarationBox = document.getElementById('declarationBox');
        declarationBox.innerHTML = `
            <h4>ØªØ¹Ù‡Ø¯ Ø§Ù„Ø³Ø§Ø¦Ù‚</h4>
            <p>Ø£ØªØ¹Ù‡Ø¯ Ø¨Ø£Ù†:</p>
            <ul style="text-align: right;">
                <li>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© ØµØ­ÙŠØ­Ø© ÙˆØ¯Ù‚ÙŠÙ‚Ø©</li>
                <li>Ø³ÙŠØ§Ø±ØªÙŠ ÙÙŠ Ø­Ø§Ù„Ø© Ø¬ÙŠØ¯Ø© ÙˆØµØ§Ù„Ø­Ø© Ù„Ù„Ù‚ÙŠØ§Ø¯Ø©</li>
                <li>Ø£Ø­Ù…Ù„ Ø±Ø®ØµØ© Ù‚ÙŠØ§Ø¯Ø© Ø³Ø§Ø±ÙŠØ© Ø§Ù„Ù…ÙØ¹ÙˆÙ„</li>
                <li>Ø³Ø£Ù‚ÙˆÙ… Ø¨ØªÙˆÙÙŠØ± Ø®Ø¯Ù…Ø© Ø¢Ù…Ù†Ø© ÙˆÙ…Ù‡Ø°Ø¨Ø© Ù„Ù„Ø±ÙƒØ§Ø¨</li>
                <li>Ø³Ø£Ø­ØªØ±Ù… Ù‚ÙˆØ§Ù†ÙŠÙ† Ø§Ù„Ù…Ø±ÙˆØ± ÙˆØ£Ù†Ø¸Ù…Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø©</li>
                <li>Ø³Ø£ØªØ­Ù…Ù„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠØ© Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ø¹Ù† Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø±ÙƒØ§Ø¨</li>
                <li>Ù„Ù† Ø£Ù‚ÙˆÙ… Ø¨Ø£ÙŠ Ø³Ù„ÙˆÙƒ ØºÙŠØ± Ù„Ø§Ø¦Ù‚ Ø£Ùˆ Ù…Ø®Ø§Ù„Ù Ù„Ù„Ù‚Ø§Ù†ÙˆÙ†</li>
            </ul>
        `;
        declarationBox.style.display = 'block';
    }

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    function logout() {
        if (currentUser) {
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Firebase
            window.set(window.ref(window.db, `locations/${currentUser.uid}`), null);
        }

        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª
        if (resendTimer) {
            clearInterval(resendTimer);
        }

        // Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        currentUser = null;
        currentRole = null;
        confirmationResult = null;
        localStorage.clear();
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…Ø§Ø°Ø¬
        document.getElementById('phoneNumber').value = '';
        document.getElementById('verificationCode').value = '';
        
        // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        showPage('loginPage');
    }

    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
    document.addEventListener('DOMContentLoaded', function() {
        // Ø¥Ø¹Ø¯Ø§Ø¯ Firebase Auth
        setupPhoneAuth();

        // Ù…Ø³ØªÙ…Ø¹ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
        const chatInput = document.getElementById('chatInput');
        if (chatInput) {
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        }

        // Ù…Ø³ØªÙ…Ø¹ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
        const verificationCodeInput = document.getElementById('verificationCode');
        if (verificationCodeInput) {
            verificationCodeInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    verifyCode();
                }
            });
        }

        // Ù…Ø³ØªÙ…Ø¹ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
        const phoneInput = document.getElementById('phoneNumber');
        if (phoneInput) {
            phoneInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendVerificationCode();
                }
            });
        }

        // ØªÙ†Ø³ÙŠÙ‚ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        phoneInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, ''); // Ø¥Ø²Ø§Ù„Ø© ÙƒÙ„ Ø´ÙŠØ¡ Ø¹Ø¯Ø§ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
            
            if (value.startsWith('213')) {
                value = '+' + value;
            } else if (value.startsWith('0')) {
                value = '+213' + value.substring(1);
            } else if (!value.startsWith('+213') && value.length > 0) {
                value = '+213' + value;
            }
            
            e.target.value = value;
        });

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        window.auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ø¥Ø¶Ø§ÙÙŠ Ù‡Ù†Ø§ Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
            }
        });
    });

    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ JavaScript Ø§Ù„Ø¹Ø§Ù…Ø©
    window.addEventListener('error', function(e) {
        console.error('JavaScript Error:', e.error);
        showMessage('error', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.');
    });

    // Ù…Ø¹Ø§Ù„Ø¬Ø© ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
    window.addEventListener('offline', function() {
        showNotification('Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„', 'ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 'error');
    });

    window.addEventListener('online', function() {
        showNotification('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„', 'ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ', 'success');
    });
</script>
</body>
</html>



